<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birth Chart Analysis - Vedic Astrology Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
        }
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
        }
        .planet-strong { color: #28a745; font-weight: bold; }
        .planet-moderate { color: #ffc107; font-weight: bold; }
        .planet-weak { color: #dc3545; font-weight: bold; }
        .yoga-detected { color: #28a745; }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .result-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark mb-4">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-star"></i> Vedic Astrology Dashboard
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/chart">Birth Chart</a>
                    <a class="nav-link" href="/dasha">Dasha</a>
                    <a class="nav-link" href="/transits">Transits</a>
                    <a class="nav-link" href="/compatibility">Compatibility</a>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Input Form -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Birth Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="birthChartForm">
                            <div class="mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="birthDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time of Birth</label>
                                <input type="time" class="form-control" id="birthTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="0.000001" class="form-control" id="latitude" 
                                       placeholder="e.g., 13.083333" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="0.000001" class="form-control" id="longitude" 
                                       placeholder="e.g., 80.283333" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Timezone Offset</label>
                                <input type="number" step="0.5" class="form-control" id="timezone" 
                                       placeholder="e.g., 5.5 for IST" required>
                            </div>
                            <button type="submit" class="btn btn-custom w-100 mb-2">
                                <i class="fas fa-calculator"></i> Calculate Chart
                            </button>
                            <button type="button" class="btn btn-secondary w-100" id="clearCacheBtn">
                                <i class="fas fa-eraser"></i> Clear Details
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-lg-8">
                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating your birth chart...</p>
                </div>

                <!-- Results Section -->
                <div class="result-section" id="results">
                    <!-- Chart Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> Chart Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Lagna (Ascendant):</strong> <span id="lagnaSign"></span></p>
                                    <p><strong>Strongest Planet:</strong> <span id="strongestPlanet"></span></p>
                                    <p><strong>Strongest House:</strong> <span id="strongestHouse"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Yogas:</strong> <span id="totalYogas"></span></p>
                                    <p><strong>Retrograde Planets:</strong> <span id="retrogradePlanets"></span></p>
                                    <p><strong>Ayanamsa:</strong> <span id="ayanamsa"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Planetary Positions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-planet-ringed"></i> Planetary Positions</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Planet</th>
                                            <th>Sign</th>
                                            <th>House</th>
                                            <th>Strength</th>
                                            <th>Dignity</th>
                                            <th>Status <span data-bs-toggle="tooltip" title="Direct: Outward energy. Retrograde: Inward, karmic, or lessons from the past." style="cursor:help;">&#9432;</span></th>
                                            <th>Shadbala <span data-bs-toggle="tooltip" title="Shadbala: Total strength of a planet (0-1). High: strong, Low: weak. Click 'Legend' below for details." style="cursor:help;">&#9432;</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="planetsTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Legend Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6>Legend: What do these mean?</h6>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li><b>Status</b>: <b>Direct</b> means the planet's energy is expressed outwardly and in a straightforward manner. <b>Retrograde</b> means the energy is more internalized, karmic, or may indicate lessons from the past.</li>
                                <li><b>Shadbala</b>: The total strength of a planet, combining six types of astrological strengths. <br>
                                    <b>High (0.7–1.0):</b> Strong, gives positive results.<br>
                                    <b>Moderate (0.5–0.7):</b> Average, mixed results.<br>
                                    <b>Low (&lt;0.5):</b> Weak, may indicate challenges.<br>
                                    <i>Shadbala is a classical Vedic measure of planetary strength.</i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- House Analysis -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-home"></i> House Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <span class="badge bg-success">Strong (≥7)</span>
                                <span class="badge bg-warning text-dark">Moderate (4–6.99)</span>
                                <span class="badge bg-danger">Weak (&lt;4)</span>
                                <span class="ms-3"><b>Strength:</b> Sum of strengths of all planets in the house plus half the strength of the house lord (Shadbala-based).</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>House</th>
                                            <th>Sign</th>
                                            <th>Element</th>
                                            <th>Purpose</th>
                                            <th>Mobility</th>
                                            <th>Strength</th>
                                            <th>Planets</th>
                                        </tr>
                                    </thead>
                                    <tbody id="housesTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Yogas -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-yin-yang"></i> Yogas Detected</h5>
                        </div>
                        <div class="card-body">
                            <div id="yogasList">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Prefill form from localStorage if available
        window.addEventListener('DOMContentLoaded', function() {
            const fields = ['birthDate', 'birthTime', 'latitude', 'longitude', 'timezone'];
            fields.forEach(f => {
                if (localStorage.getItem(f)) {
                    document.getElementById(f).value = localStorage.getItem(f);
                }
            });
        });
        document.getElementById('birthChartForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // Save to localStorage
            localStorage.setItem('birthDate', document.getElementById('birthDate').value);
            localStorage.setItem('birthTime', document.getElementById('birthTime').value);
            localStorage.setItem('latitude', document.getElementById('latitude').value);
            localStorage.setItem('longitude', document.getElementById('longitude').value);
            localStorage.setItem('timezone', document.getElementById('timezone').value);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            // Get form data
            const formData = {
                date: document.getElementById('birthDate').value,
                time: document.getElementById('birthTime').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                timezone: document.getElementById('timezone').value
            };
            
            try {
                const response = await fetch('/api/calculate_chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.chart);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error calculating chart: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            }
        });
        
        function displayResults(chart) {
            // Chart Summary
            document.getElementById('lagnaSign').textContent = chart.lagna.sign;
            document.getElementById('ayanamsa').textContent = chart.birth_info.ayanamsa + '°';
            
            // Find strongest planet
            const planets = chart.planets;
            const strongestPlanet = Object.entries(planets).reduce((a, b) => 
                planets[a[0]].strength > planets[b[0]].strength ? a : b);
            document.getElementById('strongestPlanet').textContent = 
                `${strongestPlanet[0]} (${strongestPlanet[1].strength})`;
            
            // Find strongest house
            const houses = chart.houses;
            const strongestHouse = Object.entries(houses).reduce((a, b) => 
                houses[a[0]].strength > houses[b[0]].strength ? a : b);
            document.getElementById('strongestHouse').textContent = 
                `House ${strongestHouse[0]} (${strongestHouse[1].strength})`;
            
            // Count yogas
            const yogas = Object.values(chart.yogas).filter(y => y).length;
            document.getElementById('totalYogas').textContent = yogas;
            
            // Retrograde planets
            const retrograde = Object.entries(planets)
                .filter(([name, planet]) => planet.retrograde)
                .map(([name]) => name);
            document.getElementById('retrogradePlanets').textContent = retrograde.join(', ') || 'None';
            
            // Planetary positions table
            const planetsTable = document.getElementById('planetsTable');
            planetsTable.innerHTML = '';
            
            Object.entries(planets).forEach(([name, planet]) => {
                const strengthClass = planet.strength >= 7 ? 'planet-strong' : 
                                   planet.strength >= 4 ? 'planet-moderate' : 'planet-weak';
                let shadbala = planet.shadbala && planet.shadbala.total_shadbala !== undefined ? planet.shadbala.total_shadbala : '';
                let shadbalaBreakdown = '';
                if (planet.shadbala) {
                    shadbalaBreakdown = `Sthana: ${planet.shadbala.sthana_bala ?? ''}, Dig: ${planet.shadbala.dig_bala ?? ''}, Kala: ${planet.shadbala.kala_bala ?? ''}, Cheshta: ${planet.shadbala.cheshta_bala ?? ''}, Naisargika: ${planet.shadbala.naisargika_bala ?? ''}, Drik: ${planet.shadbala.drik_bala ?? ''}`;
                }
                const row = `
                    <tr>
                        <td>${name}</td>
                        <td>${planet.sign}</td>
                        <td>${planet.house}</td>
                        <td class="${strengthClass}">${planet.strength}</td>
                        <td>${planet.dignity}</td>
                        <td>${planet.retrograde ? 'Retrograde' : 'Direct'}</td>
                        <td><span title="${shadbalaBreakdown}">${shadbala}</span></td>
                    </tr>
                `;
                planetsTable.innerHTML += row;
            });
            
            // House analysis table
            const housesTable = document.getElementById('housesTable');
            housesTable.innerHTML = '';
            
            Object.entries(houses).forEach(([num, house]) => {
                let strengthClass = '';
                if (house.strength >= 7) strengthClass = 'planet-strong';
                else if (house.strength >= 4) strengthClass = 'planet-moderate';
                else strengthClass = 'planet-weak';
                const row = `
                    <tr>
                        <td>${num}</td>
                        <td>${house.sign}</td>
                        <td>${house.element}</td>
                        <td>${house.purpose}</td>
                        <td>${house.mobility}</td>
                        <td class="${strengthClass}">${house.strength}</td>
                        <td>${house.planets.join(', ') || 'Empty'}</td>
                    </tr>
                `;
                housesTable.innerHTML += row;
            });
            
            // Yogas
            const yogasList = document.getElementById('yogasList');
            yogasList.innerHTML = '';
            
            Object.entries(chart.yogas).forEach(([yoga, detected]) => {
                if (detected) {
                    yogasList.innerHTML += `<span class="badge bg-success me-2 mb-2 yoga-detected">${yoga}</span>`;
                }
            });
        }
        // Clear Details button
        document.getElementById('clearCacheBtn').addEventListener('click', function() {
            const fields = ['birthDate', 'birthTime', 'latitude', 'longitude', 'timezone'];
            fields.forEach(f => localStorage.removeItem(f));
            document.getElementById('birthChartForm').reset();
        });

        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>
</html> 