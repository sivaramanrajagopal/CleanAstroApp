<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birth Chart Analysis - Vedic Astrology Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
        }
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
        }
        .planet-strong { color: #28a745; font-weight: bold; }
        .planet-moderate { color: #ffc107; font-weight: bold; }
        .planet-weak { color: #dc3545; font-weight: bold; }
        .yoga-detected { 
            color: white !important; 
            background-color: #28a745 !important;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .result-section {
            display: none;
        }
        
        /* Strength Dashboard Styles */
        .chart-health-score {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .score-number {
            font-size: 2rem;
            line-height: 1;
        }
        
        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .strength-stats {
            padding: 1rem;
        }
        
        .stat-box {
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        
        .stat-box.strong {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .stat-box.moderate {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .stat-box.weak {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .planet-strength-grid, .house-strength-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .strength-indicator {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .strength-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .strength-indicator.strong {
            border-left-color: #28a745;
        }
        
        .strength-indicator.moderate {
            border-left-color: #ffc107;
        }
        
        .strength-indicator.weak {
            border-left-color: #dc3545;
        }
        
        .strength-bar {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .strength-fill.strong {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        
        .strength-fill.moderate {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }
        
        .strength-fill.weak {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }
        
        .strength-score {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .strength-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .strength-details {
            font-size: 0.8rem;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark mb-4">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-star"></i> Vedic Astrology Dashboard
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="/chart">Birth Chart</a>
                    <a class="nav-link" href="/dasha">Dasha</a>
                    <a class="nav-link" href="/transits">Transits</a>
                    <a class="nav-link" href="/compatibility">Compatibility</a>
                    <a class="nav-link" href="/shadbala">Shadbala</a>
                    <a class="nav-link" href="/cosmic_connections">Cosmic Connections</a>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Input Form -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Birth Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="birthChartForm">
                            <div class="mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="birthDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time of Birth</label>
                                <input type="time" class="form-control" id="birthTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="0.000001" class="form-control" id="latitude" 
                                       placeholder="e.g., 13.083333" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="0.000001" class="form-control" id="longitude" 
                                       placeholder="e.g., 80.283333" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Timezone Offset</label>
                                <input type="number" step="0.5" class="form-control" id="timezone" 
                                       placeholder="e.g., 5.5 for IST" required>
                            </div>
                            <button type="submit" class="btn btn-custom w-100 mb-2">
                                <i class="fas fa-calculator"></i> Calculate Chart
                            </button>
                            <button type="button" class="btn btn-secondary w-100 mb-2" id="clearCacheBtn">
                                <i class="fas fa-eraser"></i> Clear Details
                            </button>
                            <button type="button" class="btn btn-info w-100" id="generatePdfBtn" style="display: none;">
                                <i class="fas fa-file-pdf"></i> Download PDF Report
                            </button>
                            <div id="cacheIndicator" class="alert alert-info mt-2" style="display: none;">
                                <i class="fas fa-info-circle"></i> <span id="cacheMessage"></span>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-lg-8">
                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating your birth chart...</p>
                </div>

                <!-- Results Section -->
                <div class="result-section" id="results">
                    <!-- Chart Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> Chart Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Lagna (Ascendant):</strong> <span id="lagnaSign"></span></p>
                                    <p><strong>Strongest Planet:</strong> <span id="strongestPlanet"></span></p>
                                    <p><strong>Strongest House:</strong> <span id="strongestHouse"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Yogas:</strong> <span id="totalYogas"></span></p>
                                    <p><strong>Retrograde Planets:</strong> <span id="retrogradePlanets"></span></p>
                                    <p><strong>Ayanamsa:</strong> <span id="ayanamsa"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Strength Dashboard -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tachometer-alt"></i> Strength Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <!-- Overall Chart Health -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h6>Overall Chart Health</h6>
                                        <div class="chart-health-score" id="chartHealthScore">
                                            <div class="score-circle">
                                                <span class="score-number" id="healthScoreNumber">0</span>
                                                <span class="score-label">/ 100</span>
                                            </div>
                                        </div>
                                        <div class="health-status mt-2" id="healthStatus">
                                            <span class="badge bg-secondary">Calculating...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="strength-stats">
                                        <h6>Strength Distribution</h6>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="stat-box strong">
                                                    <div class="stat-number" id="strongPlanets">0</div>
                                                    <div class="stat-label">Strong</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-box moderate">
                                                    <div class="stat-number" id="moderatePlanets">0</div>
                                                    <div class="stat-label">Moderate</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-box weak">
                                                    <div class="stat-number" id="weakPlanets">0</div>
                                                    <div class="stat-label">Weak</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Planet Strength Indicators -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6>Planet Strength Indicators</h6>
                                    <div class="planet-strength-grid" id="planetStrengthGrid">
                                        <!-- Planet strength indicators will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- House Strength Indicators -->
                            <div class="row">
                                <div class="col-12">
                                    <h6>House Strength Indicators</h6>
                                    <div class="house-strength-grid" id="houseStrengthGrid">
                                        <!-- House strength indicators will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Planetary Positions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-planet-ringed"></i> Planetary Positions</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Planet</th>
                                            <th>Sign</th>
                                            <th>House</th>
                                            <th>Strength</th>
                                            <th>Dignity</th>
                                            <th>Status <span data-bs-toggle="tooltip" title="Direct: Outward energy. Retrograde: Inward, karmic, or lessons from the past." style="cursor:help;">&#9432;</span></th>
                                            <th>Shadbala <span data-bs-toggle="tooltip" title="Shadbala: Total strength of a planet (0-1). High: strong, Low: weak. Click 'Legend' below for details." style="cursor:help;">&#9432;</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="planetsTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Legend Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6>Legend: What do these mean?</h6>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li><b>Status</b>: <b>Direct</b> means the planet's energy is expressed outwardly and in a straightforward manner. <b>Retrograde</b> means the energy is more internalized, karmic, or may indicate lessons from the past.</li>
                                <li><b>Shadbala</b>: The total strength of a planet, combining six types of astrological strengths. <br>
                                    <b>High (0.7–1.0):</b> Strong, gives positive results.<br>
                                    <b>Moderate (0.5–0.7):</b> Average, mixed results.<br>
                                    <b>Low (&lt;0.5):</b> Weak, may indicate challenges.<br>
                                    <i>Shadbala is a classical Vedic measure of planetary strength.</i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- House Analysis -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-home"></i> House Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <span class="badge bg-success">Strong (≥7)</span>
                                <span class="badge bg-warning text-dark">Moderate (4–6.99)</span>
                                <span class="badge bg-danger">Weak (&lt;4)</span>
                                <span class="ms-3"><b>Strength:</b> Sum of strengths of all planets in the house plus half the strength of the house lord (Shadbala-based).</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>House</th>
                                            <th>Sign</th>
                                            <th>Element</th>
                                            <th>Purpose</th>
                                            <th>Mobility</th>
                                            <th>Strength</th>
                                            <th>Planets</th>
                                        </tr>
                                    </thead>
                                    <tbody id="housesTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Yogas -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-yin-yang"></i> Yogas Detected</h5>
                        </div>
                        <div class="card-body">
                            <div id="yogasList">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Prefill form from localStorage if available
        window.addEventListener('DOMContentLoaded', function() {
            const fields = ['birthDate', 'birthTime', 'latitude', 'longitude', 'timezone'];
            fields.forEach(f => {
                if (localStorage.getItem(f)) {
                    document.getElementById(f).value = localStorage.getItem(f);
                }
            });
        });
        document.getElementById('birthChartForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // Save to localStorage
            localStorage.setItem('birthDate', document.getElementById('birthDate').value);
            localStorage.setItem('birthTime', document.getElementById('birthTime').value);
            localStorage.setItem('latitude', document.getElementById('latitude').value);
            localStorage.setItem('longitude', document.getElementById('longitude').value);
            localStorage.setItem('timezone', document.getElementById('timezone').value);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            // Get form data
            const formData = {
                date: document.getElementById('birthDate').value,
                time: document.getElementById('birthTime').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                timezone: document.getElementById('timezone').value
            };
            
            try {
                const response = await fetch('/api/calculate_chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.chart);
                    
                    // Show cache indicator if data was cached
                    if (data.cached) {
                        document.getElementById('cacheIndicator').style.display = 'block';
                        document.getElementById('cacheMessage').textContent = 'Results loaded from cache for faster response.';
                    } else {
                        document.getElementById('cacheIndicator').style.display = 'block';
                        document.getElementById('cacheMessage').textContent = 'Results calculated and cached for future use.';
                        setTimeout(() => {
                            document.getElementById('cacheIndicator').style.display = 'none';
                        }, 3000);
                    }
                    
                    // Show PDF button
                    document.getElementById('generatePdfBtn').style.display = 'block';
                    
                    // Store chart data for PDF generation
                    window.currentChartData = data.chart;
                    window.currentFormData = formData;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error calculating chart: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            }
        });
        
        function displayResults(chart) {
            // Chart Summary
            document.getElementById('lagnaSign').textContent = chart.lagna.sign;
            document.getElementById('ayanamsa').textContent = chart.birth_info.ayanamsa + '°';
            
            // Find strongest planet
            const planets = chart.planets;
            const strongestPlanet = Object.entries(planets).reduce((a, b) => 
                planets[a[0]].strength > planets[b[0]].strength ? a : b);
            document.getElementById('strongestPlanet').textContent = 
                `${strongestPlanet[0]} (${strongestPlanet[1].strength})`;
            
            // Find strongest house
            const houses = chart.houses;
            const strongestHouse = Object.entries(houses).reduce((a, b) => 
                houses[a[0]].strength > houses[b[0]].strength ? a : b);
            document.getElementById('strongestHouse').textContent = 
                `House ${strongestHouse[0]} (${strongestHouse[1].strength})`;
            
            // Count yogas
            const yogas = Object.values(chart.yogas).filter(y => y).length;
            document.getElementById('totalYogas').textContent = yogas;
            
            // Retrograde planets
            const retrograde = Object.entries(planets)
                .filter(([name, planet]) => planet.retrograde)
                .map(([name]) => name);
            document.getElementById('retrogradePlanets').textContent = retrograde.join(', ') || 'None';
            
            // Update Strength Dashboard
            updateStrengthDashboard(planets, houses, yogas);
            
            // Planetary positions table
            const planetsTable = document.getElementById('planetsTable');
            planetsTable.innerHTML = '';
            
            Object.entries(planets).forEach(([name, planet]) => {
                const strengthClass = planet.strength >= 7 ? 'planet-strong' : 
                                   planet.strength >= 4 ? 'planet-moderate' : 'planet-weak';
                let shadbala = planet.shadbala && planet.shadbala.total_shadbala !== undefined ? planet.shadbala.total_shadbala : '';
                let shadbalaBreakdown = '';
                if (planet.shadbala) {
                    shadbalaBreakdown = `Sthana: ${planet.shadbala.sthana_bala ?? ''}, Dig: ${planet.shadbala.dig_bala ?? ''}, Kala: ${planet.shadbala.kala_bala ?? ''}, Cheshta: ${planet.shadbala.cheshta_bala ?? ''}, Naisargika: ${planet.shadbala.naisargika_bala ?? ''}, Drik: ${planet.shadbala.drik_bala ?? ''}`;
                }
                const row = `
                    <tr>
                        <td>${name}</td>
                        <td>${planet.sign}</td>
                        <td>${planet.house}</td>
                        <td class="${strengthClass}">${planet.strength}</td>
                        <td>${planet.dignity}</td>
                        <td>${planet.retrograde ? 'Retrograde' : 'Direct'}</td>
                        <td><span title="${shadbalaBreakdown}">${shadbala}</span></td>
                    </tr>
                `;
                planetsTable.innerHTML += row;
            });
            
            // House analysis table
            const housesTable = document.getElementById('housesTable');
            housesTable.innerHTML = '';
            
            Object.entries(houses).forEach(([num, house]) => {
                let strengthClass = '';
                if (house.strength >= 7) strengthClass = 'planet-strong';
                else if (house.strength >= 4) strengthClass = 'planet-moderate';
                else strengthClass = 'planet-weak';
                const row = `
                    <tr>
                        <td>${num}</td>
                        <td>${house.sign}</td>
                        <td>${house.element}</td>
                        <td>${house.purpose}</td>
                        <td>${house.mobility}</td>
                        <td class="${strengthClass}">${house.strength}</td>
                        <td>${house.planets.join(', ') || 'Empty'}</td>
                    </tr>
                `;
                housesTable.innerHTML += row;
            });
            
            // Yogas
            const yogasList = document.getElementById('yogasList');
            yogasList.innerHTML = '';
            
            Object.entries(chart.yogas).forEach(([yoga, detected]) => {
                if (detected) {
                    yogasList.innerHTML += `<span class="badge bg-success me-2 mb-2 yoga-detected">${yoga}</span>`;
                }
            });
        }
        // Clear Details button
        document.getElementById('clearCacheBtn').addEventListener('click', function() {
            const fields = ['birthDate', 'birthTime', 'latitude', 'longitude', 'timezone'];
            fields.forEach(f => localStorage.removeItem(f));
            document.getElementById('birthChartForm').reset();
        });

        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Strength Dashboard Functions
        function updateStrengthDashboard(planets, houses, yogas) {
            // Calculate overall health score
            const healthScore = calculateHealthScore(planets, houses, yogas);
            updateHealthScore(healthScore);
            
            // Update strength distribution
            updateStrengthDistribution(planets);
            
            // Update planet strength indicators
            updatePlanetStrengthIndicators(planets);
            
            // Update house strength indicators
            updateHouseStrengthIndicators(houses);
        }
        
        function calculateHealthScore(planets, houses, yogas) {
            let totalScore = 0;
            let maxScore = 0;
            
            // Planet strength contribution (40% weight)
            const planetScores = Object.values(planets).map(p => p.strength);
            const avgPlanetStrength = planetScores.reduce((a, b) => a + b, 0) / planetScores.length;
            const planetScore = Math.min(avgPlanetStrength / 10 * 40, 40); // Max 40 points
            totalScore += planetScore;
            maxScore += 40;
            
            // House strength contribution (40% weight)
            const houseScores = Object.values(houses).map(h => h.strength);
            const avgHouseStrength = houseScores.reduce((a, b) => a + b, 0) / houseScores.length;
            const houseScore = Math.min(avgHouseStrength / 10 * 40, 40); // Max 40 points
            totalScore += houseScore;
            maxScore += 40;
            
            // Yogas contribution (20% weight)
            const yogaScore = Math.min(yogas * 2, 20); // 1 yoga = 2 points, max 20
            totalScore += yogaScore;
            maxScore += 20;
            
            return Math.round((totalScore / maxScore) * 100);
        }
        
        function updateHealthScore(score) {
            document.getElementById('healthScoreNumber').textContent = score;
            
            const healthStatus = document.getElementById('healthStatus');
            let statusClass = 'bg-secondary';
            let statusText = 'Poor';
            
            if (score >= 80) {
                statusClass = 'bg-success';
                statusText = 'Excellent';
            } else if (score >= 60) {
                statusClass = 'bg-info';
                statusText = 'Good';
            } else if (score >= 40) {
                statusClass = 'bg-warning';
                statusText = 'Moderate';
            } else if (score >= 20) {
                statusClass = 'bg-danger';
                statusText = 'Weak';
            }
            
            healthStatus.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
        }
        
        function updateStrengthDistribution(planets) {
            let strong = 0, moderate = 0, weak = 0;
            
            Object.values(planets).forEach(planet => {
                if (planet.strength >= 7) strong++;
                else if (planet.strength >= 4) moderate++;
                else weak++;
            });
            
            document.getElementById('strongPlanets').textContent = strong;
            document.getElementById('moderatePlanets').textContent = moderate;
            document.getElementById('weakPlanets').textContent = weak;
        }
        
        function updatePlanetStrengthIndicators(planets) {
            const grid = document.getElementById('planetStrengthGrid');
            grid.innerHTML = '';
            
            Object.entries(planets).forEach(([name, planet]) => {
                const strengthClass = getStrengthClass(planet.strength);
                const strengthPercent = Math.min((planet.strength / 10) * 100, 100);
                
                const indicator = `
                    <div class="strength-indicator ${strengthClass}">
                        <div class="strength-label">${name}</div>
                        <div class="strength-score">${planet.strength.toFixed(1)}</div>
                        <div class="strength-bar">
                            <div class="strength-fill ${strengthClass}" style="width: ${strengthPercent}%"></div>
                        </div>
                        <div class="strength-details">
                            ${planet.sign} • House ${planet.house} • ${planet.dignity}
                            ${planet.retrograde ? ' • Retrograde' : ''}
                        </div>
                    </div>
                `;
                grid.innerHTML += indicator;
            });
        }
        
        function updateHouseStrengthIndicators(houses) {
            const grid = document.getElementById('houseStrengthGrid');
            grid.innerHTML = '';
            
            Object.entries(houses).forEach(([num, house]) => {
                const strengthClass = getStrengthClass(house.strength);
                const strengthPercent = Math.min((house.strength / 10) * 100, 100);
                
                const indicator = `
                    <div class="strength-indicator ${strengthClass}">
                        <div class="strength-label">House ${num}</div>
                        <div class="strength-score">${house.strength.toFixed(1)}</div>
                        <div class="strength-bar">
                            <div class="strength-fill ${strengthClass}" style="width: ${strengthPercent}%"></div>
                        </div>
                        <div class="strength-details">
                            ${house.sign} • ${house.element} • ${house.purpose}
                            ${house.planets.length > 0 ? ` • ${house.planets.join(', ')}` : ' • Empty'}
                        </div>
                    </div>
                `;
                grid.innerHTML += indicator;
            });
        }
        
        function getStrengthClass(strength) {
            if (strength >= 7) return 'strong';
            if (strength >= 4) return 'moderate';
            return 'weak';
        }
        
        // PDF Generation
        document.getElementById('generatePdfBtn').addEventListener('click', async function() {
            if (!window.currentChartData || !window.currentFormData) {
                alert('Please calculate a chart first.');
                return;
            }
            
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            button.disabled = true;
            
            try {
                const pdfData = {
                    ...window.currentFormData,
                    name: 'Birth Chart Analysis',
                    place: 'Birth Location'
                };
                
                const response = await fetch('/api/generate_chart_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pdfData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Download the PDF
                    window.open(data.download_url, '_blank');
                } else {
                    alert('Error generating PDF: ' + data.error);
                }
            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    </script>

    <!-- Chart Strength Calculation Details -->
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-calculator"></i> Chart Strength Calculation Methodology</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-primary">Overall Health Score Formula</h5>
                        <div class="alert alert-success">
                            <h6><i class="fas fa-heartbeat"></i> Health Score = (Planet Score + House Score + Yoga Score) / 100</h6>
                            <ul class="mb-0">
                                <li><strong>Planet Strength (40%):</strong> Average of all planet strengths</li>
                                <li><strong>House Strength (40%):</strong> Average of all house strengths</li>
                                <li><strong>Yoga Count (20%):</strong> Number of auspicious yogas detected</li>
                            </ul>
                        </div>

                        <h5 class="text-primary mt-4">Planet Strength Calculation</h5>
                        <div class="accordion" id="planetCalculationAccordion">
                            
                            <!-- Dignity -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="dignityHeader">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dignityCollapse">
                                        <strong>Dignity Assessment (30% weight)</strong>
                                    </button>
                                </h2>
                                <div id="dignityCollapse" class="accordion-collapse collapse show" data-bs-parent="#planetCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Exalted (Uccha):</strong> 10/10 (100% strength)</li>
                                            <li><strong>Own Sign (Swa):</strong> 8/10 (80% strength)</li>
                                            <li><strong>Mooltrikona:</strong> 7/10 (70% strength)</li>
                                            <li><strong>Friendly (Mitra):</strong> 6/10 (60% strength)</li>
                                            <li><strong>Neutral (Sama):</strong> 5/10 (50% strength)</li>
                                            <li><strong>Enemy (Shatru):</strong> 4/10 (40% strength)</li>
                                            <li><strong>Debilitated (Neecha):</strong> 2/10 (20% strength)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- House Position -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="housePositionHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#housePositionCollapse">
                                        <strong>House Position (25% weight)</strong>
                                    </button>
                                </h2>
                                <div id="housePositionCollapse" class="accordion-collapse collapse" data-bs-parent="#planetCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Kendra Houses (1,4,7,10):</strong> +2 points (strongest)</li>
                                            <li><strong>Trikona Houses (1,5,9):</strong> +1.5 points</li>
                                            <li><strong>Upachaya Houses (3,6,10,11):</strong> +1 point</li>
                                            <li><strong>Dusthana Houses (6,8,12):</strong> -1 point (weakest)</li>
                                            <li><strong>Neutral Houses (2,3,5,9,11):</strong> +0.5 points</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Motion -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="motionHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#motionCollapse">
                                        <strong>Motion Status (20% weight)</strong>
                                    </button>
                                </h2>
                                <div id="motionCollapse" class="accordion-collapse collapse" data-bs-parent="#planetCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Direct Motion:</strong> +1 point (normal strength)</li>
                                            <li><strong>Retrograde Motion:</strong> +2 points (enhanced strength)</li>
                                            <li><strong>Stationary:</strong> +1.5 points (moderate enhancement)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Shadbala -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="shadbalaHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shadbalaCollapse">
                                        <strong>Shadbala Integration (25% weight)</strong>
                                    </button>
                                </h2>
                                <div id="shadbalaCollapse" class="accordion-collapse collapse" data-bs-parent="#planetCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Sthana Bala:</strong> Positional strength (0-1 scale)</li>
                                            <li><strong>Dig Bala:</strong> Directional strength (0-1 scale)</li>
                                            <li><strong>Kala Bala:</strong> Temporal strength (0-1 scale)</li>
                                            <li><strong>Cheshta Bala:</strong> Motional strength (0-1 scale)</li>
                                            <li><strong>Naisargika Bala:</strong> Natural strength (0-1 scale)</li>
                                            <li><strong>Drik Bala:</strong> Aspectual strength (0-1 scale)</li>
                                            <li><strong>Total:</strong> Average of all 6 components</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="text-primary">House Strength Calculation</h5>
                        <div class="accordion" id="houseCalculationAccordion">
                            
                            <!-- House Type -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="houseTypeHeader">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#houseTypeCollapse">
                                        <strong>House Classification (40% weight)</strong>
                                    </button>
                                </h2>
                                <div id="houseTypeCollapse" class="accordion-collapse collapse show" data-bs-parent="#houseCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Kendra Houses (1,4,7,10):</strong> 9/10 (90% strength)</li>
                                            <li><strong>Trikona Houses (1,5,9):</strong> 8/10 (80% strength)</li>
                                            <li><strong>Upachaya Houses (3,6,10,11):</strong> 7/10 (70% strength)</li>
                                            <li><strong>Neutral Houses (2,3,5,9,11):</strong> 6/10 (60% strength)</li>
                                            <li><strong>Dusthana Houses (6,8,12):</strong> 4/10 (40% strength)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Occupancy -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="occupancyHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#occupancyCollapse">
                                        <strong>Planet Occupancy (30% weight)</strong>
                                    </button>
                                </h2>
                                <div id="occupancyCollapse" class="accordion-collapse collapse" data-bs-parent="#houseCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Benefic Planets:</strong> +2 points per planet</li>
                                            <li><strong>Malefic Planets:</strong> -1 point per planet</li>
                                            <li><strong>Neutral Planets:</strong> +0.5 points per planet</li>
                                            <li><strong>Empty House:</strong> 0 points (neutral)</li>
                                            <li><strong>Multiple Planets:</strong> Cumulative effect</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Element -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="elementHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#elementCollapse">
                                        <strong>Element Strength (30% weight)</strong>
                                    </button>
                                </h2>
                                <div id="elementCollapse" class="accordion-collapse collapse" data-bs-parent="#houseCalculationAccordion">
                                    <div class="accordion-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Fire Signs (Aries, Leo, Sagittarius):</strong> 8/10 (80% strength)</li>
                                            <li><strong>Earth Signs (Taurus, Virgo, Capricorn):</strong> 7/10 (70% strength)</li>
                                            <li><strong>Air Signs (Gemini, Libra, Aquarius):</strong> 6/10 (60% strength)</li>
                                            <li><strong>Water Signs (Cancer, Scorpio, Pisces):</strong> 7/10 (70% strength)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="text-primary mt-4">Strength Indicators</h5>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Understanding the Indicators</h6>
                            <ul class="mb-0">
                                <li><span class="badge bg-success">Strong:</span> Score ≥ 7.0 (70% or higher)</li>
                                <li><span class="badge bg-warning">Moderate:</span> Score 4.0-6.9 (40-69%)</li>
                                <li><span class="badge bg-danger">Weak:</span> Score < 4.0 (below 40%)</li>
                            </ul>
                        </div>

                        <h5 class="text-primary mt-4">Yoga Contribution</h5>
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-star"></i> Auspicious Yogas</h6>
                            <ul class="mb-0">
                                <li><strong>Each Yoga:</strong> +2 points to overall health score</li>
                                <li><strong>Maximum Yoga Score:</strong> 20 points (10 yogas)</li>
                                <li><strong>Common Yogas:</strong> Gajakesari, Budhaditya, etc.</li>
                                <li><strong>Effect:</strong> Enhances overall chart strength</li>
                            </ul>
                        </div>

                        <h5 class="text-primary mt-4">Calculation Transparency</h5>
                        <div class="alert alert-light">
                            <h6><i class="fas fa-eye"></i> Open Source Methodology</h6>
                            <ul class="mb-0">
                                <li>All calculations follow traditional Vedic principles</li>
                                <li>Based on Parashara Hora Shastra methodology</li>
                                <li>Source code available for verification</li>
                                <li>Results can be cross-verified with classical texts</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 